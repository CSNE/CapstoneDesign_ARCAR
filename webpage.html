<!DOCTYPE html>
<html>
<head>
	<title>ARCAR Web Renderer</title>
	<script type="module" src="./webpage.js"></script>
	<style>
	@keyframes flash {
		from {background-color: #A0FFA0;}
		to {background-color: #FFFFFF;}
	}
	</style>
</head>
<body>
	<div id="buttonContainer">
	<button onclick='playbackControl("pause");'>Pause</button>
	<button onclick='playbackControl("play");'>Play</button>
	<button onclick='playbackControl("+1");'>Next</button>
	<button onclick='playbackControl("-1");'>Prev</button>
	<button onclick='playbackControl("+10");'>+10</button>
	<button onclick='playbackControl("-10");'>-10</button>
	<button onclick='playbackControl("+100");'>+100</button>
	<button onclick='playbackControl("-100");'>-100</button>
	<button onclick='playbackControl("rand");'>Random</button>
	</div>
	<div id="information"></div>
	<div id="imgsContainer" style="display:flex;flex-direction:row;flex-wrap:wrap;"></div>
	<canvas id="pc_monodepth"> </canvas>
	<canvas id="pc_opencv"> </canvas>
	<canvas id="pc_psmnet"> </canvas>
	
	<script>
		// Periodically fetch data form server
		var infoDiv=document.getElementById("information");
		
		var imgsContainerDiv=document.getElementById("imgsContainer");
		var image_targets={
			"raw":"Raw Image (L)",
			"dif":"Stereo Difference",
			"str":"Stereo Image (R)",
			
			"dmd":"MonoDepth Monocular Depth",
			"dcv":"OpenCV Stereo Depth",
			"dpsm":"PSMNet Stereo Depth",
			
			"seg":"Segmentation",
			"com":"Seg+Depth",
			
			}
		var canvas_targets={
			"pc_monodepth":"Point Cloud (MonoDepth)",
			"pc_opencv":"Point Cloud (OpenCV)",
			"pc_psmnet":"Point Cloud (PSMNet)"
		}
		var imgDOMs={};
		function addCell(e,s){
			var outerDiv=document.createElement("div");
			outerDiv.style="width:fit-content;display:flex; flex-direction: column; border:1px solid;"
			imgsContainer.appendChild(outerDiv);
			
			var span=document.createElement("span");
			var tn=document.createTextNode(s);
			span.appendChild(tn);
			outerDiv.appendChild(span);
			outerDiv.appendChild(e);
		}
		
		for (k in image_targets){
			var img=document.createElement("img");
			img.style="width:480px;height:270px;";
			addCell(img,image_targets[k])
			imgDOMs[k]=img;
		}
		for (k in canvas_targets){
			addCell(document.getElementById(k),canvas_targets[k]);
		}
		
		
		function update_all(){
			var xhr=new XMLHttpRequest();
			xhr.open("GET","/information");
			xhr.addEventListener("load",function(e){
				if (xhr.status==200) infoDiv.innerHTML=xhr.responseText;
			});
			xhr.addEventListener("error",function(e){
				//console.log("Request errored.");
			});
			xhr.overrideMimeType("text/plain");
			xhr.send();
			
			for (k in imgDOMs){
				/*
				//imgDOMs[k].onload=function(){console.log("Img"+k+"Loaded");};
				imgDOMs[k].onload=function(){
					textDOMs[k].style.animation ="flash 0.5s ease-in";
				};*/
				//console.log(imgDOMs[k]);
				imgDOMs[k].src=k+".jpg?forcereload="+(new Date()).getTime();
				
				
			}
		}
		
		var last_update_flag;
		function updateCheck(){
			var xhr=new XMLHttpRequest();
			xhr.open("GET","/update_flag");
			xhr.addEventListener("load",function(e){
				if (xhr.status==200){
					if (xhr.responseText != last_update_flag){
						console.log("Updating images");
						last_update_flag=xhr.responseText;
						update_all();
					}
					
				}
			});
			xhr.addEventListener("error",function(e){
				console.log("Request errored.");
			});
			xhr.send();
		}
		setInterval(updateCheck,50);

		function playbackControl(type){
			var xhr=new XMLHttpRequest();
			xhr.open("GET","/playbackControl?type="+encodeURIComponent(type));
			xhr.send();
		}
	</script>
	
	
	</body>
</html>
